# Location 坐标定位与映射模块

## 模块概述

Location模块是雷达站的核心定位组件，负责建立相机坐标系与世界坐标系之间的映射关系，并提供高精度的3D位置计算和跟踪预测功能。

该模块通过四点标定技术建立坐标变换矩阵，结合深度信息实现准确的目标定位。

## 系统架构

### 坐标系变换链
系统采用多级坐标系变换：
1. **图像坐标系** → **相机坐标系**（相机内参）
2. **相机坐标系** → **世界坐标系**（四点标定外参）
3. **深度融合**（激光雷达深度信息）
4. **位置预测**（运动轨迹预测）

### 智能预测机制
- 基于历史轨迹的位置预测
- IoU匹配的目标关联
- 多跟踪器兼容的ID管理
- Z轴突变检测和修正

## 文件结构

```
Location/
├── include/
│   ├── location.h       # 四点标定模块接口
│   └── MapMapping.h     # 坐标映射模块接口
└── src/
    ├── location.cpp     # 四点标定模块实现
    └── MapMapping.cpp   # 坐标映射模块实现
```

---

## 四点标定模块

### Location类

四点标定模块提供交互式的相机-世界坐标系标定功能，通过手动选择对应点建立精确的坐标变换关系。

#### 核心功能
- 交互式四点标定界面
- 多种PnP算法自动选择
- 亚像素精度的角点检测
- 重投影误差评估
- 标定点配置文件管理

#### 标定流程
1. **配置加载**：从JSON文件加载标定点的世界坐标
2. **交互界面**：显示相机图像，用户依次点击对应点
3. **亚像素优化**：使用cornerSubPix提高点击精度
4. **PnP求解**：尝试多种算法，选择最优结果
5. **误差评估**：计算重投影误差，验证标定质量



## 多算法PnP求解

系统支持多种PnP算法并自动选择最优结果：

**支持的算法**：
- **P3P**：经典的三点透视算法
- **AP3P**：改进的三点透视算法
- **EPNP**：高效的n点透视算法

**算法选择策略**：
系统会尝试所有支持的PnP算法，计算每种算法的重投影误差，自动选择误差最小的算法结果作为最终的标定结果。

#### 配置文件格式
标定点配置采用JSON格式，包含以下字段：
- **Points**: 标定点数组，每个点包含name、x、y、z坐标
- **when_enemy_red**: 红方标定时使用的点序列
- **when_enemy_blue**: 蓝方标定时使用的点序列

配置文件应包含至少4个标定点，分别对应场地的四个位置。



## 坐标映射模块

### MapMapping类

坐标映射模块负责将检测到的目标从相机坐标系转换到世界坐标系，并提供智能的跟踪预测功能。

#### 核心功能
- 3D坐标系变换计算
- 基于历史轨迹的位置预测
- IoU匹配的目标关联
- 多跟踪器兼容的ID管理
- Z轴突变检测和修正
- 区域可视化绘制

#### 坐标变换原理
系统使用齐次坐标进行3D变换：

**变换矩阵构建**：
系统将旋转向量转换为旋转矩阵，与平移向量组合构建4x4的齐次变换矩阵。

**坐标变换计算**：
首先将图像坐标去畸变并转换为归一化坐标，然后结合深度信息构建3D点的齐次坐标，最后通过变换矩阵将其转换到世界坐标系。



## 智能预测算法

##### 位置预测
基于历史轨迹进行运动预测：
系统维护两帧历史位置信息，通过计算位置差值估算目标运动速度，然后根据预测比例系数推算下一帧的可能位置。

##### IoU匹配关联
使用IoU匹配进行目标关联：
系统计算缓存检测框与当前分割框的重叠区域，通过IoU值评估目标的匹配程度。当IoU值超过设定阈值时，认为是同一目标，从而实现跨帧的目标关联和跟踪连续性。

#### 通用跟踪器支持

兼容多种跟踪器的ID管理：
系统建立类别ID到跟踪ID的映射关系，支持ByteTracker、DeepSort等多种跟踪算法。当目标暂时丢失时，系统能够根据历史跟踪ID恢复目标，保持跟踪的连续性。

#### Z轴突变修正
检测和修正Z轴方向的异常跳变：
系统监测目标Z轴坐标的变化幅度，当检测到超过阈值的突变时，计算从相机到目标的射线方向，使用历史Z值重新计算目标的X、Y坐标，从而修正异常的位置跳变。



---

**注意**：该模块是雷达站系统的核心定位组件，标定质量直接影响整个系统的定位精度。